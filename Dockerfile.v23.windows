# π’ μ†”λ΅λ¬λ“ AI μ—”μ§„ v2.3 Windows μ „μ© Dockerfile
# Windows ν™κ²½ μµμ ν™” λ° νΈν™μ„± λ³΄μ¥

# λ©€ν‹°μ¤ν…μ΄μ§€ λΉλ“: Windows νΈν™μ„± μµμ ν™”
FROM python:3.11-slim as builder

# Windows νΈν™ λΉλ“ μμ΅΄μ„± μ„¤μΉ
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Python μμ΅΄μ„± μ‚¬μ „ μ„¤μΉ (Windows νΈν™ λ²„μ „)
WORKDIR /build
COPY requirements_v23_windows.txt .
RUN pip install --no-cache-dir --user -r requirements_v23_windows.txt

# =============================================================================
# Windows μµμ ν™” ν”„λ΅λ•μ… μ΄λ―Έμ§€
FROM python:3.11-slim as production

# λ©”νƒ€λ°μ΄ν„°
LABEL maintainer="μ „κ·Όν <solomond.jgh@gmail.com>"
LABEL version="v2.3-windows"
LABEL description="μ†”λ΅λ¬λ“ AI μ—”μ§„ v2.3 - Windows νΈν™ λ²„μ „"

# Windows νΈν™ μ‹μ¤ν… ν¨ν‚¤μ§€ μ„¤μΉ
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsndfile1 \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# λΉ„κ¶ν• μ‚¬μ©μ μƒμ„±
RUN groupadd -r solomond && useradd -r -g solomond solomond

# μ‘μ—… λ””λ ‰ν† λ¦¬ μ„¤μ •
WORKDIR /app

# λΉλ“ λ‹¨κ³„μ—μ„ μ„¤μΉλ Python ν¨ν‚¤μ§€ λ³µμ‚¬
COPY --from=builder /root/.local /home/solomond/.local
ENV PATH=/home/solomond/.local/bin:$PATH

# Windows νΈν™ v2.3 ν•µμ‹¬ λ¨λ“λ“¤ λ³µμ‚¬
COPY core/__init__.py ./core/
COPY core/hybrid_llm_manager_v23.py ./core/
COPY core/jewelry_specialized_prompts_v23.py ./core/
COPY core/ai_quality_validator_v23.py ./core/
COPY core/ai_benchmark_system_v23.py ./core/

# Windows νΈν™ μ‹¤ν–‰ νμΌλ“¤
COPY integration_test_v23.py ./
COPY solomond_ai_platform_v23_integrated.py ./
COPY api_server_v23.py ./
COPY jewelry_stt_ui_v23_hybrid.py ./

# κΈ°λ³Έ νμΌλ“¤ (Windows νΈν™μ„± ν™•μΈλ¨)
COPY main.py ./
COPY requirements_v23_windows.txt ./

# ν•„μ”ν• λ””λ ‰ν† λ¦¬ μƒμ„± λ° κ¶ν• μ„¤μ •
RUN mkdir -p uploads data models logs cache \
    && chown -R solomond:solomond /app \
    && chmod 755 /app

# Windows μµμ ν™” ν™κ²½ λ³€μ
ENV PYTHONPATH=/app
ENV ENVIRONMENT=production
ENV LOG_LEVEL=INFO
ENV WHISPER_MODEL_SIZE=base
ENV MAX_WORKERS=2
ENV PLATFORM=windows
ENV PYTHONIOENCODING=utf-8

# ν¬νΈ λ…Έμ¶
EXPOSE 8080

# Windows νΈν™ ν—¬μ¤μ²΄ν¬
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/health || curl -f http://localhost:8080/ || exit 1

# μ‚¬μ©μ μ „ν™
USER solomond

# Windows νΈν™ μ‹¤ν–‰ λ…λ Ή (κ°€μ¥ μ•μ •μ μΈ λ°©λ²•)
CMD ["python", "-u", "jewelry_stt_ui_v23_hybrid.py"]

# λ€μ• μ‹¤ν–‰ λ…λ Ήλ“¤
# CMD ["python", "-u", "main.py"]
# CMD ["python", "-u", "api_server_v23.py"]
