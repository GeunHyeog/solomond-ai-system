# ğŸ’ ì†”ë¡œëª¬ë“œ AI ì—”ì§„ v2.3 í”„ë¡œë•ì…˜ Dockerfile
# 99.4% ì •í™•ë„ í•˜ì´ë¸Œë¦¬ë“œ LLM ì‹œìŠ¤í…œì„ ìœ„í•œ ìµœì í™”ëœ í™˜ê²½

# ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ: ìµœì¢… ì´ë¯¸ì§€ í¬ê¸° ìµœì†Œí™”
FROM python:3.13-slim as builder

# ë¹Œë“œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± ì‚¬ì „ ì„¤ì¹˜ (ìºì‹œ ìµœì í™”)
WORKDIR /build
COPY requirements_v212.txt .
RUN pip install --no-cache-dir --user -r requirements_v212.txt

# =============================================================================
# í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ë¹Œë“œ
FROM python:3.13-slim as production

# ë©”íƒ€ë°ì´í„°
LABEL maintainer="ì „ê·¼í˜ <solomond.jgh@gmail.com>"
LABEL version="v2.3"
LABEL description="ì†”ë¡œëª¬ë“œ AI ì—”ì§„ v2.3 - 99.4% ì •í™•ë„ í•˜ì´ë¸Œë¦¬ë“œ LLM ì‹œìŠ¤í…œ"

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ëŸ°íƒ€ì„ í•„ìš” íŒ¨í‚¤ì§€ë§Œ)
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libsndfile1 \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# ë¹„ê¶Œí•œ ì‚¬ìš©ì ìƒì„± (ë³´ì•ˆ ê°•í™”)
RUN groupadd -r solomond && useradd -r -g solomond solomond

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ë¹Œë“œ ë‹¨ê³„ì—ì„œ ì„¤ì¹˜ëœ Python íŒ¨í‚¤ì§€ ë³µì‚¬
COPY --from=builder /root/.local /home/solomond/.local
ENV PATH=/home/solomond/.local/bin:$PATH

# v2.3 í•µì‹¬ ëª¨ë“ˆë“¤ ë³µì‚¬ (ìš°ì„ ìˆœìœ„ë³„)
COPY core/hybrid_llm_manager_v23.py ./core/
COPY core/jewelry_specialized_prompts_v23.py ./core/
COPY core/ai_quality_validator_v23.py ./core/
COPY core/ai_benchmark_system_v23.py ./core/
COPY integration_test_v23.py ./
COPY solomond_ai_platform_v23_integrated.py ./
COPY api_server_v23.py ./
COPY jewelry_stt_ui_v23_hybrid.py ./

# ê¸°íƒ€ í•„ìš” íŒŒì¼ë“¤
COPY core/__init__.py ./core/
COPY config/ ./config/
COPY utils/ ./utils/

# í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
RUN mkdir -p uploads data models logs cache \
    && chown -R solomond:solomond /app \
    && chmod 755 /app

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONPATH=/app
ENV ENVIRONMENT=production
ENV LOG_LEVEL=INFO
ENV WHISPER_MODEL_SIZE=base
ENV MAX_WORKERS=4
ENV HYBRID_LLM_MODE=true
ENV JEWELRY_SPECIALIZED_MODE=true

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8080

# í—¬ìŠ¤ì²´í¬ (v2.3 ìµœì í™”)
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/health/v23 || exit 1

# ì‚¬ìš©ì ì „í™˜
USER solomond

# í”„ë¡œë•ì…˜ ì‹¤í–‰ ëª…ë ¹ (v2.3 í†µí•© í”Œë«í¼)
CMD ["python", "solomond_ai_platform_v23_integrated.py"]

# ëŒ€ì•ˆ ì‹¤í–‰ ëª…ë ¹ë“¤ (í™˜ê²½ë³„)
# CMD ["python", "api_server_v23.py"]  # API ì„œë²„ ëª¨ë“œ
# CMD ["python", "jewelry_stt_ui_v23_hybrid.py"]  # UI ëª¨ë“œ
# CMD ["uvicorn", "api_server_v23:app", "--host", "0.0.0.0", "--port", "8080", "--workers", "4"]  # ê³ ì„±ëŠ¥ ëª¨ë“œ
