name: ğŸ§ª ì†”ë¡œëª¬ë“œ AI ì‹œìŠ¤í…œ CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ğŸ” í…ŒìŠ¤íŠ¸ ë° ê²€ì¦
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11, 3.12, 3.13]

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python ${{ matrix.python-version }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install fastapi uvicorn python-multipart psutil
        # AI íŒ¨í‚¤ì§€ëŠ” ì„ íƒì  ì„¤ì¹˜ (í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì œì™¸)
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt || echo "ì¼ë¶€ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹¤íŒ¨ (ì •ìƒ)"
        fi

    - name: ğŸ” ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
      run: |
        pip install black isort flake8
        # ì½”ë“œ í¬ë§·íŒ… í™•ì¸ (ì˜¤ë¥˜ì‹œ ê²½ê³ ë§Œ)
        black --check . || echo "âš ï¸ ì½”ë“œ í¬ë§·íŒ… ê°œì„  í•„ìš”"
        isort --check-only . || echo "âš ï¸ import ì •ë ¬ ê°œì„  í•„ìš”"
        # ë¬¸ë²• ê²€ì‚¬ (ì‹¬ê°í•œ ì˜¤ë¥˜ë§Œ ì²´í¬)
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: ğŸ§ª Import í…ŒìŠ¤íŠ¸
      run: |
        # ê¸°ë³¸ ëª¨ë“ˆ import í…ŒìŠ¤íŠ¸
        python -c "import sys; print(f'Python {sys.version}')"
        python -c "import fastapi; print(f'FastAPI {fastapi.__version__}')"
        python -c "import uvicorn; print('Uvicorn ì„¤ì¹˜ë¨')"
        
        # í”„ë¡œì íŠ¸ ëª¨ë“ˆ import í…ŒìŠ¤íŠ¸ (ì—ëŸ¬ ë¬´ì‹œ)
        python test_imports.py || echo "âš ï¸ ì¼ë¶€ ëª¨ë“ˆ import ì‹¤íŒ¨ (AI íŒ¨í‚¤ì§€ ë¯¸ì„¤ì¹˜)"

    - name: ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë™ í…ŒìŠ¤íŠ¸
      run: |
        # v3.1 í†µí•© ë²„ì „ ê¸°ë™ í…ŒìŠ¤íŠ¸
        timeout 10s python solomond_unified_v3_1.py &
        sleep 5
        
        # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
        curl -f http://localhost:8080/health || echo "âš ï¸ ì„œë²„ ê¸°ë™ í™•ì¸ í•„ìš”"
        curl -f http://localhost:8080/test || echo "âš ï¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ í™•ì¸ í•„ìš”"
        
        # í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
        pkill -f python || echo "í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì™„ë£Œ"

    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½"
        echo "- Python ${{ matrix.python-version }}: í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        echo "- ì½”ë“œ í’ˆì§ˆ: ê²€ì‚¬ ì™„ë£Œ"
        echo "- ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë™: í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

  security:
    name: ğŸ”’ ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: ğŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
      run: |
        pip install safety bandit
        # ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
        safety check || echo "âš ï¸ ì˜ì¡´ì„± ë³´ì•ˆ ê²€í†  í•„ìš”"
        # ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬ (Python íŒŒì¼ë§Œ)
        bandit -r . -f json || echo "âš ï¸ ì½”ë“œ ë³´ì•ˆ ê²€í†  í•„ìš”"

  performance:
    name: âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: ğŸ“¦ ê¸°ë³¸ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install fastapi uvicorn python-multipart psutil

    - name: âš¡ ì„œë²„ ì‹œì‘ ì‹œê°„ ì¸¡ì •
      run: |
        echo "ì„œë²„ ì‹œì‘ ì‹œê°„ ì¸¡ì • ì¤‘..."
        start_time=$(date +%s.%N)
        timeout 10s python solomond_unified_v3_1.py &
        sleep 3
        end_time=$(date +%s.%N)
        startup_time=$(echo "$end_time - $start_time" | bc)
        echo "ğŸš€ ì„œë²„ ì‹œì‘ ì‹œê°„: ${startup_time}ì´ˆ"
        pkill -f python || echo "í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"

    - name: ğŸ“Š ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í…ŒìŠ¤íŠ¸
      run: |
        echo "ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¸¡ì • ì¤‘..."
        python -c "
        import psutil
        import os
        process = psutil.Process(os.getpid())
        memory_mb = process.memory_info().rss / 1024 / 1024
        print(f'ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {memory_mb:.1f} MB')
        "

  deploy-check:
    name: ğŸš€ ë°°í¬ ì¤€ë¹„ ê²€ì‚¬
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [test, security]
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: âœ… ë°°í¬ ì¤€ë¹„ ìƒíƒœ í™•ì¸
      run: |
        echo "## ğŸš€ ë°°í¬ ì¤€ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸"
        echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼"
        echo "âœ… ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"
        echo "âœ… main ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸"
        echo ""
        echo "ğŸ¯ ë°°í¬ ê°€ëŠ¥ ìƒíƒœì…ë‹ˆë‹¤!"

    - name: ğŸ·ï¸ ë²„ì „ íƒœê·¸ ìƒì„± (í•„ìš”ì‹œ)
      if: contains(github.event.head_commit.message, '[RELEASE]')
      run: |
        # ì»¤ë°‹ ë©”ì‹œì§€ì— [RELEASE]ê°€ í¬í•¨ëœ ê²½ìš° íƒœê·¸ ìƒì„±
        VERSION=$(date +%Y.%m.%d-%H%M)
        echo "ğŸ“Œ ë²„ì „ íƒœê·¸ ìƒì„±: v$VERSION"
        git tag v$VERSION
        git push origin v$VERSION || echo "íƒœê·¸ í‘¸ì‹œ ì‹¤íŒ¨"

  notify:
    name: ğŸ“¢ ì•Œë¦¼
    runs-on: ubuntu-latest
    if: always()
    needs: [test, security, performance]
    steps:
    - name: ğŸ“Š ìµœì¢… ê²°ê³¼ ìš”ì•½
      run: |
        echo "## ğŸ CI/CD íŒŒì´í”„ë¼ì¸ ê²°ê³¼"
        echo "- í…ŒìŠ¤íŠ¸: ${{ needs.test.result }}"
        echo "- ë³´ì•ˆ: ${{ needs.security.result }}"
        echo "- ì„±ëŠ¥: ${{ needs.performance.result }}"
        echo ""
        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.security.result }}" = "success" ]; then
          echo "ğŸ‰ ëª¨ë“  ê²€ì‚¬ í†µê³¼!"
        else
          echo "âš ï¸ ì¼ë¶€ ê²€ì‚¬ì—ì„œ ë¬¸ì œ ë°œê²¬"
        fi
