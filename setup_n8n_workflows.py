#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸš€ SOLOMOND AI - n8n ì›Œí¬í”Œë¡œìš° ìë™ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
n8n APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë“€ì–¼ ë¸Œë ˆì¸ ì›Œí¬í”Œë¡œìš°ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê³  í™œì„±í™”
"""

import requests
import json
import time
from pathlib import Path

class N8nWorkflowSetup:
    def __init__(self):
        self.base_url = "http://localhost:5678/rest"
        self.session = requests.Session()
        
    def check_n8n_health(self):
        """n8n ì„œë²„ ìƒíƒœ í™•ì¸"""
        try:
            response = self.session.get("http://localhost:5678/healthz", timeout=5)
            if response.status_code == 200:
                print("n8n ì„œë²„ ì •ìƒ ì‘ë™ ì¤‘")
                return True
        except Exception as e:
            print(f"n8n ì„œë²„ ì—°ê²° ì‹¤íŒ¨: {e}")
            return False
    
    def get_credentials(self):
        """ê¸°ì¡´ Google Calendar ìê²©ì¦ëª… ID ì¡°íšŒ"""
        try:
            response = self.session.get(f"{self.base_url}/credentials")
            if response.status_code == 200:
                credentials = response.json()
                for cred in credentials:
                    if cred.get('type') == 'googleCalendarOAuth2Api':
                        print(f"Google Calendar ìê²©ì¦ëª… ë°œê²¬: {cred['id']}")
                        return cred['id']
            print("Google Calendar ìê²©ì¦ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
            return None
        except Exception as e:
            print(f"ìê²©ì¦ëª… ì¡°íšŒ ì‹¤íŒ¨: {e}")
            return None
    
    def create_dual_brain_workflow(self, credential_id):
        """ë“€ì–¼ ë¸Œë ˆì¸ ì›Œí¬í”Œë¡œìš° ìƒì„±"""
        workflow_data = {
            "name": "SOLOMOND Dual Brain Pipeline",
            "active": True,
            "nodes": [
                {
                    "id": "webhook_trigger",
                    "name": "ë¶„ì„ ì™„ë£Œ íŠ¸ë¦¬ê±°",
                    "type": "n8n-nodes-base.webhook",
                    "position": [250, 300],
                    "parameters": {
                        "httpMethod": "POST",
                        "path": "analysis-complete",
                        "responseMode": "responseNode",
                        "options": {}
                    }
                },
                {
                    "id": "status_check",
                    "name": "ìƒíƒœ í™•ì¸",
                    "type": "n8n-nodes-base.function",
                    "position": [450, 300],
                    "parameters": {
                        "functionCode": """
// SOLOMOND AI ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬
const analysisData = $input.all()[0].json;

// ë¶„ì„ ì„±ê³µ ì—¬ë¶€ í™•ì¸
const isSuccess = analysisData.success_count > 0;
const totalFiles = analysisData.total_files || 0;
const successCount = analysisData.success_count || 0;

// ì²˜ë¦¬ëœ ë°ì´í„° ë°˜í™˜
return [{
  json: {
    ...analysisData,
    processed: true,
    timestamp: new Date().toISOString(),
    success_rate: totalFiles > 0 ? (successCount / totalFiles) * 100 : 0,
    calendar_ready: isSuccess
  }
}];
"""
                    }
                },
                {
                    "id": "calendar_event",
                    "name": "ìº˜ë¦°ë” ì´ë²¤íŠ¸ ìƒì„±",
                    "type": "n8n-nodes-base.googleCalendar",
                    "position": [650, 300],
                    "parameters": {
                        "operation": "create",
                        "calendarId": "primary",
                        "title": "=ğŸ¯ SOLOMOND AI ë¶„ì„: {{$json.pre_info.conference_name || 'Unknown'}}",
                        "description": "=ğŸ“Š ì†”ë¡œëª¬ë“œ AI ë¶„ì„ ê²°ê³¼\\n\\nğŸ¯ ì»¨í¼ëŸ°ìŠ¤: {{$json.pre_info.conference_name || 'Unknown'}}\\nğŸ“… ë¶„ì„ì¼ì‹œ: {{$json.timestamp}}\\nğŸ“ ë¶„ì„íŒŒì¼: {{$json.total_files}}ê°œ\\nâœ… ì„±ê³µë¥ : {{$json.success_count}}/{{$json.total_files}} ({{Math.round($json.success_rate)}}%)\\n\\nğŸ¤– Generated by SOLOMOND AI Dual Brain System",
                        "start": "={{new Date().toISOString()}}",
                        "end": "={{new Date(Date.now() + 3600000).toISOString()}}",
                        "options": {
                            "colorId": "9"
                        }
                    },
                    "credentials": {
                        "googleCalendarOAuth2Api": {
                            "id": credential_id
                        }
                    }
                },
                {
                    "id": "response_node",
                    "name": "ì‘ë‹µ",
                    "type": "n8n-nodes-base.respondToWebhook",
                    "position": [850, 300],
                    "parameters": {
                        "respondWith": "json",
                        "responseBody": "={\"status\": \"success\", \"message\": \"SOLOMOND AI ë“€ì–¼ ë¸Œë ˆì¸ ì²˜ë¦¬ ì™„ë£Œ\", \"analysis_id\": \"{{$('ìƒíƒœ í™•ì¸').item.json.analysis_id}}\", \"calendar_event\": \"{{$('ìº˜ë¦°ë” ì´ë²¤íŠ¸ ìƒì„±').item.json.id}}\", \"timestamp\": \"{{new Date().toISOString()}}\"}"
                    }
                }
            ],
            "connections": {
                "ë¶„ì„ ì™„ë£Œ íŠ¸ë¦¬ê±°": {
                    "main": [
                        [
                            {
                                "node": "ìƒíƒœ í™•ì¸",
                                "type": "main",
                                "index": 0
                            }
                        ]
                    ]
                },
                "ìƒíƒœ í™•ì¸": {
                    "main": [
                        [
                            {
                                "node": "ìº˜ë¦°ë” ì´ë²¤íŠ¸ ìƒì„±",
                                "type": "main", 
                                "index": 0
                            }
                        ]
                    ]
                },
                "ìº˜ë¦°ë” ì´ë²¤íŠ¸ ìƒì„±": {
                    "main": [
                        [
                            {
                                "node": "ì‘ë‹µ",
                                "type": "main",
                                "index": 0
                            }
                        ]
                    ]
                }
            },
            "settings": {
                "executionOrder": "v1"
            }
        }
        
        try:
            response = self.session.post(f"{self.base_url}/workflows", json=workflow_data)
            if response.status_code in [200, 201]:
                workflow = response.json()
                print(f"ë“€ì–¼ ë¸Œë ˆì¸ ì›Œí¬í”Œë¡œìš° ìƒì„± ì™„ë£Œ: {workflow['id']}")
                return workflow['id']
            else:
                print(f"ì›Œí¬í”Œë¡œìš° ìƒì„± ì‹¤íŒ¨: {response.status_code} - {response.text}")
                return None
        except Exception as e:
            print(f"ì›Œí¬í”Œë¡œìš° ìƒì„± ì˜¤ë¥˜: {e}")
            return None
    
    def activate_workflow(self, workflow_id):
        """ì›Œí¬í”Œë¡œìš° í™œì„±í™”"""
        try:
            response = self.session.patch(f"{self.base_url}/workflows/{workflow_id}/activate")
            if response.status_code == 200:
                print(f"ì›Œí¬í”Œë¡œìš° í™œì„±í™” ì™„ë£Œ: {workflow_id}")
                return True
            else:
                print(f"ì›Œí¬í”Œë¡œìš° í™œì„±í™” ì‹¤íŒ¨: {response.status_code}")
                return False
        except Exception as e:
            print(f"ì›Œí¬í”Œë¡œìš° í™œì„±í™” ì˜¤ë¥˜: {e}")
            return False
    
    def get_webhook_url(self, workflow_id):
        """ì›Œí¬í”Œë¡œìš° ì›¹í›… URL ì¡°íšŒ"""
        try:
            response = self.session.get(f"{self.base_url}/workflows/{workflow_id}")
            if response.status_code == 200:
                workflow = response.json()
                # webhook ë…¸ë“œì—ì„œ path ì¶”ì¶œ
                for node in workflow.get('nodes', []):
                    if node.get('type') == 'n8n-nodes-base.webhook':
                        path = node.get('parameters', {}).get('path', 'analysis-complete')
                        webhook_url = f"http://localhost:5678/webhook/{path}"
                        print(f"ì›¹í›… URL: {webhook_url}")
                        return webhook_url
            return None
        except Exception as e:
            print(f"ì›¹í›… URL ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return None
    
    def run_setup(self):
        """ì „ì²´ ì„¤ì • í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰"""
        print("SOLOMOND AI n8n ì›Œí¬í”Œë¡œìš° ìë™ ì„¤ì • ì‹œì‘")
        print("=" * 50)
        
        # 1. n8n ì„œë²„ ìƒíƒœ í™•ì¸
        if not self.check_n8n_health():
            print("n8n ì„œë²„ë¥¼ ë¨¼ì € ì‹œì‘í•´ì£¼ì„¸ìš”")
            return False
        
        # 2. Google Calendar ìê²©ì¦ëª… í™•ì¸
        credential_id = self.get_credentials()
        if not credential_id:
            print("Google Calendar ìê²©ì¦ëª…ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”")
            return False
        
        # 3. ë“€ì–¼ ë¸Œë ˆì¸ ì›Œí¬í”Œë¡œìš° ìƒì„±
        workflow_id = self.create_dual_brain_workflow(credential_id)
        if not workflow_id:
            print("ì›Œí¬í”Œë¡œìš° ìƒì„± ì‹¤íŒ¨")
            return False
        
        # 4. ì›Œí¬í”Œë¡œìš° í™œì„±í™”
        if not self.activate_workflow(workflow_id):
            print("ì›Œí¬í”Œë¡œìš° í™œì„±í™” ì‹¤íŒ¨")
            return False
        
        # 5. ì›¹í›… URL í™•ì¸
        webhook_url = self.get_webhook_url(workflow_id)
        
        # 6. ì„¤ì • ì™„ë£Œ ì •ë³´ ì €ì¥
        setup_info = {
            "workflow_id": workflow_id,
            "webhook_url": webhook_url,
            "credential_id": credential_id,
            "setup_time": time.time(),
            "status": "active"
        }
        
        with open("n8n_setup_info.json", "w", encoding="utf-8") as f:
            json.dump(setup_info, f, indent=2, ensure_ascii=False)
        
        print("\nSOLOMOND AI n8n ì›Œí¬í”Œë¡œìš° ì„¤ì • ì™„ë£Œ!")
        print("=" * 50)
        print(f"ì›Œí¬í”Œë¡œìš° ID: {workflow_id}")
        print(f"ì›¹í›… URL: {webhook_url}")
        print(f"ìê²©ì¦ëª… ID: {credential_id}")
        print("\nì´ì œ SOLOMOND ì»¨í¼ëŸ°ìŠ¤ ë¶„ì„ê³¼ ì—°ë™ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!")
        
        return True

if __name__ == "__main__":
    setup = N8nWorkflowSetup()
    setup.run_setup()